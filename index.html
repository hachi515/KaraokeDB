<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイリスト登録</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 1s linear infinite;
        }
        
        /* Background Pattern */
        .bg-pattern {
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen relative pb-20">

    <!-- Background -->
    <div class="fixed inset-0 z-0 bg-pattern"></div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-5xl mx-auto pt-6 px-4">
        
        <!-- Header -->
        <div class="bg-white/90 backdrop-blur-md rounded-t-2xl shadow-sm border-b border-gray-200 p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-500 rounded-lg text-white">
                    <i data-lucide="music"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">マイリスト登録</h1>
                    <p class="text-xs text-gray-500">My Setlist Database</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="app.loadFromGAS()" class="flex items-center gap-1.5 px-3 py-2 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-100 shadow-sm" title="サーバーから最新データを取得して更新">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5" id="refresh-icon"></i>
                    <span>データ更新</span>
                </button>
            </div>
        </div>

        <!-- Terms / Warning Message -->
        <div class="bg-white/50 backdrop-blur-sm border-x border-gray-200 px-4 py-2 text-center">
            <p class="text-[10px] sm:text-xs text-gray-800 font-bold leading-relaxed text-left">
                ※マイリストの使用に当たり、本ツールはゆかりカラオケに参加する方のみでの利用でお願いします。<br class="hidden sm:inline">
                第三者への共有時には本ツールの趣旨を踏まえて、ゆかりカラオケを利用するユーザーのみを対象にお願いします。
            </p>
        </div>

        <!-- Content -->
        <div class="bg-white/80 backdrop-blur-sm shadow-xl min-h-[600px] flex flex-col md:flex-row">
            
            <!-- Left Column: Input & Singer List -->
            <div class="w-full md:w-80 bg-white/50 border-r border-gray-200 p-6 flex flex-col gap-6">
                
                <!-- Input Form -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative transition-all duration-300" id="input-form-container">
                    <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2" id="form-title">
                        <i data-lucide="plus" class="text-blue-500 w-4 h-4" id="form-icon"></i> <span id="form-title-text">新規登録</span>
                    </h2>
                    
                    <!-- Cancel Edit Button (Hidden by default) -->
                    <button onclick="app.cancelEdit()" id="cancel-edit-btn" class="hidden absolute top-4 right-4 text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1">
                        <i data-lucide="x" class="w-3 h-3"></i> キャンセル
                    </button>

                    <div class="space-y-3">
                        <div class="relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Singer</label>
                            <input type="text" id="input-singer" placeholder="歌唱者名を入力"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Info</label>
                            <input type="text" id="input-work" placeholder="作品名"
                                class="w-full px-3 py-2 mb-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                            <input type="text" id="input-artist" placeholder="歌手名"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Song</label>
                            <input type="text" id="input-song" placeholder="曲名 (必須)"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                        </div>

                        <!-- Checkboxes: Tags -->
                        <div class="flex flex-wrap items-center gap-4 pt-1">
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-part-division" class="w-4 h-4 text-red-500 bg-gray-50 border-gray-300 rounded focus:ring-red-400 cursor-pointer">
                                <label for="input-part-division" class="text-xs text-gray-600 cursor-pointer select-none font-medium">パート分け</label>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-practicing" class="w-4 h-4 text-blue-500 bg-gray-50 border-gray-300 rounded focus:ring-blue-400 cursor-pointer">
                                <label for="input-practicing" class="text-xs text-gray-600 cursor-pointer select-none font-medium">練習中</label>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-review-needed" class="w-4 h-4 text-yellow-500 bg-gray-50 border-gray-300 rounded focus:ring-yellow-400 cursor-pointer">
                                <label for="input-review-needed" class="text-xs text-gray-600 cursor-pointer select-none font-medium">要復習</label>
                            </div>
                            <!-- 非公開機能 -->
                            <div class="flex items-center gap-1.5 w-full mt-1 border-t border-gray-100 pt-2">
                                <input type="checkbox" id="input-private" onchange="app.togglePrivateInput()" class="w-4 h-4 text-purple-500 bg-gray-50 border-gray-300 rounded focus:ring-purple-400 cursor-pointer">
                                <label for="input-private" class="text-xs text-gray-600 cursor-pointer select-none font-medium">非公開設定</label>
                            </div>
                            <!-- パスワード入力欄 -->
                            <div id="private-password-container" class="hidden w-full transition-all">
                                <input type="text" id="input-view-password" placeholder="閲覧用パスワードを設定"
                                    class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 transition-all">
                            </div>
                        </div>

                        <button onclick="app.saveSong()" id="submit-btn" class="w-full py-2.5 mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]">
                            リストに追加
                        </button>
                    </div>
                </div>

                <!-- Singer Filter & Search -->
                <div class="flex-1 flex flex-col">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">表示フィルター</h3>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-4">
                        
                        <!-- Singer Select -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">歌唱者</label>
                            <div class="relative">
                                <select id="singer-filter-select" onchange="app.setActiveTab(this.value)" 
                                    class="w-full pl-3 pr-10 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 cursor-pointer">
                                    <option value="ALL">全ての歌唱者を表示</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-400 text-right" id="singer-count-display"></div>
                        </div>

                        <!-- Search Box -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">リスト内検索</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="list-search-input" placeholder="スペースでAND検索" onkeydown="if(event.key==='Enter') app.triggerSearch()" oninput="app.toggleClearButton(this.value)"
                                        class="w-full pl-3 pr-8 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                    <button onclick="app.clearSearch()" id="search-clear-btn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i data-lucide="x-circle" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <button onclick="app.triggerSearch()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-lg transition-colors flex items-center gap-1 text-sm font-bold active:scale-95">
                                    <i data-lucide="search" class="w-4 h-4"></i>
                                    検索
                                </button>
                            </div>
                        </div>

                        <!-- Tag Filter -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">絞り込み</label>
                            <div class="flex flex-wrap gap-3">
                                <div class="flex items-center gap-1">
                                    <input type="checkbox" id="filter-part-division" onchange="app.toggleFilterTag('isPartDivision')" class="w-3.5 h-3.5 text-red-500 bg-gray-50 border-gray-300 rounded focus:ring-red-400 cursor-pointer">
                                    <label for="filter-part-division" class="text-xs text-gray-600 cursor-pointer select-none">パート分け</label>
                                </div>
                                <div class="flex items-center gap-1">
                                    <input type="checkbox" id="filter-practicing" onchange="app.toggleFilterTag('isPracticing')" class="w-3.5 h-3.5 text-blue-500 bg-gray-50 border-gray-300 rounded focus:ring-blue-400 cursor-pointer">
                                    <label for="filter-practicing" class="text-xs text-gray-600 cursor-pointer select-none">練習中</label>
                                </div>
                                <div class="flex items-center gap-1">
                                    <input type="checkbox" id="filter-review-needed" onchange="app.toggleFilterTag('isReviewNeeded')" class="w-3.5 h-3.5 text-yellow-500 bg-gray-50 border-gray-300 rounded focus:ring-yellow-400 cursor-pointer">
                                    <label for="filter-review-needed" class="text-xs text-gray-600 cursor-pointer select-none">要復習</label>
                                </div>
                            </div>
                        </div>

                        <!-- View Password Filter -->
                        <div class="pt-2 border-t border-gray-100 mt-2">
                            <label class="block text-xs font-bold text-gray-500 mb-2">非公開リスト閲覧</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="password" id="filter-view-password" placeholder="パスワードを入力" onkeydown="if(event.key==='Enter') app.triggerRender()"
                                        class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 transition-all">
                                </div>
                                <button onclick="app.triggerRender()" class="px-3 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg transition-colors flex items-center gap-1 text-sm font-bold active:scale-95">
                                    適用
                                </button>
                            </div>
                        </div>

                        <!-- Target Port Selection -->
                        <div class="pt-2 border-t border-gray-100">
                            <label class="block text-xs font-bold text-gray-500 mb-2">検索先の機材係 (部屋)</label>
                            <button onclick="app.openRoomModal()" id="current-room-btn"
                                class="w-full text-left px-3 py-2 bg-green-50 border border-green-200 hover:bg-green-100 text-green-700 rounded-lg text-xs font-bold flex items-center justify-between transition-colors">
                                <span><i data-lucide="monitor" class="w-3 h-3 inline mr-1"></i> <span id="current-room-name">つぼはち部屋 (11059)</span></span>
                                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Right Column: Song List -->
            <div class="flex-1 flex flex-col min-h-[500px]">
                <!-- Toolbar -->
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white/50">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2" id="list-title">
                        <i data-lucide="list-plus"></i> All Songs
                    </h2>
                    <div class="text-xs text-gray-500" id="song-count">0 tracks</div>
                </div>

                <!-- Header -->
                <div class="grid grid-cols-12 gap-2 md:gap-4 px-2 md:px-6 py-2 bg-gray-50/50 text-[10px] font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100">
                    <div class="col-span-1 text-center">No.</div>
                    <div class="col-span-4 md:col-span-5">Song Title</div>
                    <div class="col-span-4 md:col-span-4">Information</div>
                    <div class="col-span-3 md:col-span-2 text-right">Action</div>
                </div>

                <!-- List Body -->
                <div id="song-list-container" class="flex-1 overflow-y-auto bg-white/30 custom-scrollbar p-2"></div>

                <!-- Pagination -->
                <div id="pagination-container" class="p-3 border-t border-gray-100 bg-white/50 flex justify-center items-center gap-4 text-sm"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-white/90 backdrop-blur-md rounded-b-2xl shadow-sm border-t border-gray-200 p-4 flex justify-between items-center gap-2">
             <div class="flex-1 text-xs text-gray-400 font-mono flex items-center gap-2" id="status-message"></div>
             
             <!-- CSV Menu Button -->
             <button onclick="app.openCSVModal()" 
                class="flex items-center gap-2 px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full font-bold transition-colors active:scale-95" title="CSVエクスポート/インポート">
                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                <span class="hidden sm:inline">CSV</span>
             </button>

             <!-- File Inputs -->
             <input type="file" id="file-import-json" class="hidden" accept=".json" onchange="app.handleJSONImport(this)">
             <input type="file" id="file-import-csv" class="hidden" accept=".csv" onchange="app.handleCSVImport(this)">

             <!-- Restoration Button -->
             <button onclick="document.getElementById('file-import-json').click()" 
                class="flex items-center gap-2 px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full font-bold transition-colors active:scale-95" title="karaoke_mylist.jsonで復元">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                <span class="hidden sm:inline">取込</span>
             </button>

             <button onclick="app.saveToGAS()"
                class="flex items-center gap-2 px-6 py-2.5 bg-gray-800 hover:bg-gray-900 text-white rounded-full font-bold shadow-lg shadow-gray-400/20 transition-all transform hover:-translate-y-0.5 active:scale-95">
                <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                <span>同期して保存</span>
             </button>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Custom Dialog -->
    <div id="custom-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative modal-animate text-center">
            <div id="dialog-icon" class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-blue-100 text-blue-500 mb-4">
                <i data-lucide="info"></i>
            </div>
            <p id="dialog-message" class="text-sm text-gray-700 font-medium mb-6 whitespace-pre-wrap"></p>
            <div id="dialog-actions" class="flex gap-2 justify-center"></div>
        </div>
    </div>

    <!-- Room Selection Modal -->
    <div id="room-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative modal-animate flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="monitor" class="text-green-500"></i> 機材係 (部屋) 選択
                </h3>
                <button onclick="app.closeRoomModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>

            <!-- Search Mode Toggle -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-2">検索方式の設定 (基本)</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-1.5 text-sm cursor-pointer">
                        <input type="radio" name="search-type" value="yukarister" onchange="app.setSearchType(this.value)" class="text-green-500 focus:ring-green-500">
                        <span class="text-gray-700">ゆかりすたー検索</span>
                    </label>
                    <label class="flex items-center gap-1.5 text-sm cursor-pointer">
                        <input type="radio" name="search-type" value="everything" onchange="app.setSearchType(this.value)" class="text-green-500 focus:ring-green-500">
                        <span class="text-gray-700">Everything検索</span>
                    </label>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">※ポート番号 11058, 11060 を選択した場合は自動的にEverything検索になります。</p>
            </div>

            <div class="mb-4 pt-4 border-t border-gray-100">
                <label class="block text-xs font-bold text-gray-500 mb-1">ポート番号を直接入力 (任意)</label>
                <div class="flex gap-2">
                    <input type="number" id="room-input-port" placeholder="11059" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500">
                    <button onclick="app.setCustomPort()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg whitespace-nowrap">設定</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar border-t border-gray-100 pt-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="room-buttons-container"></div>
            </div>
        </div>
    </div>

    <!-- CSV Modal -->
    <div id="csv-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative modal-animate text-center">
            <button onclick="app.closeCSVModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-center gap-2">
                <i data-lucide="file-spreadsheet" class="text-green-600"></i> CSV操作
            </h3>
            <div class="space-y-3">
                <p class="text-xs text-gray-500 text-left mb-2">用途に合わせて出力形式を選択してください。<br>※非公開設定の曲はエクスポートされません。</p>
                
                <button onclick="app.exportCSV(true)" class="w-full py-3 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors border border-blue-200">
                    <i data-lucide="download"></i> 全件エクスポート (バックアップ)
                </button>

                <button onclick="app.exportCSV(false)" class="w-full py-3 bg-gray-50 hover:bg-gray-100 text-gray-700 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors border border-gray-200">
                    <i data-lucide="file-plus"></i> 様式のみエクスポート (追加用)
                </button>
                
                <div class="border-t border-gray-100 my-2"></div>
                
                <p class="text-xs text-gray-500 text-left mb-1">CSVファイルを読み込んでリストを更新・追加します。<br>※歌唱者と曲名が一致するデータは上書き更新されます。</p>
                <button onclick="document.getElementById('file-import-csv').click()" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-colors shadow-md active:scale-[0.98]">
                    <i data-lucide="upload"></i> CSVインポート (更新/追加)
                </button>
                
                <div class="text-[10px] text-gray-400 mt-2 text-left bg-gray-50 p-2 rounded">
                    <strong>CSV形式:</strong><br>
                    歌唱者, 作品名, 歌手, 曲名, パート分け(0/1), 練習中(0/1), 要復習(0/1)<br>
                    ※文字コード: UTF-8推奨
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = (() => {
            // ▼▼▼ GASのウェブアプリURL (設定済み) ▼▼▼
            const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwhx-_zhE7IJvRLgOegHpQ5WYqC6cBG3fENWtMa0sEX0Rwnh__dPoS25OPkkU9xvIDp/exec'; 
            // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

            const ITEMS_PER_PAGE = 10;
            const initialData = [
                { id: 1, singer: '月見ヤチヨ', work: 'Orbit', artist: 'yuigot', song: 'Remember', isPrivate: false, viewPassword: '' },
                { id: 2, singer: '月見ヤチヨ', work: 'Orbit', artist: 'Aqu3ra', song: '星降る海', isPrivate: false, viewPassword: '' },
                { id: 3, singer: 'V.A.', work: 'Compilation', artist: 'Unknown', song: '私は、わたしの事が好き。', isPrivate: false, viewPassword: '' },
            ];

            const ROOMS = {
                11000: "ゆーふうりん部屋", 11001: "ゆーふうりん部屋", 11002: "ゆーふうりん部屋", 11003: "ゆーふうりん部屋", 11004: "ゆーふうりん部屋",
                11005: "ゆーふうりん部屋", 11006: "ゆーふうりん部屋", 11007: "ゆーふうりん部屋", 11008: "ゆーふうりん部屋", 11009: "ゆーふうりん部屋",
                11021: "成田部屋", 11022: "成田部屋", 11028: "タマ部屋", 11058: "すみた部屋", 11059: "つぼはち部屋",
                11060: "れん部屋", 11061: "百合川部屋",
                11063: "なぎ部屋", 11064: "naoo部屋", 11066: "芝ちゃん部屋", 11067: "crom部屋", 11068: "けんしん部屋", 11069: "けんちぃ部屋",
                11070: "黒河部屋", 11071: "黒河部屋", 11073: "コウ艦長部屋", 11074: "tukinowa部屋", 11077: "v3部屋", 11078: "のんでるん部屋", 11079: "まどか部屋",
                11082: "ヤマテル部屋", 11084: "タカヒロ部屋", 11085: "タカヒロ部屋", 11086: "タカヒロ部屋", 11087: "MiO部屋", 11088: "ほっしー部屋",
                11091: "千秋部屋", 11092: "ヒロ部屋", 11101: "えみち部屋", 11102: "るえ部屋", 11103: "ながし部屋", 11104: "MrN部屋",
                11105: "ヤマテル部屋", 11106: "遠見塚部屋", 11107: "ブルーベリー部屋"
            };

            // State
            let storedData = localStorage.getItem('myMusicList');
            let songs = storedData ? JSON.parse(storedData) : initialData;
            let deletedIds = JSON.parse(localStorage.getItem('deletedIds')) || [];
            let activeTab = 'ALL';
            let searchQuery = '';
            let targetPort = parseInt(localStorage.getItem('targetPort')) || 11059;
            let targetSearchType = localStorage.getItem('targetSearchType') || 'yukarister';
            let currentPage = 1;
            let editingId = null; 
            let filterTags = { isPartDivision: false, isPracticing: false, isReviewNeeded: false };
            
            // Internal GitHub Config (Hardcoded as requested)
            const githubConfig = {
                token: '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',
                owner: 'hachi515',
                repo: 'KaraokeDB',
                path: 'backup/karaoke_list_backup.json'
            };
            let forceOverwriteMode = false;

            const els = {
                singerFilterSelect: document.getElementById('singer-filter-select'),
                singerCountDisplay: document.getElementById('singer-count-display'),
                songList: document.getElementById('song-list-container'),
                songCount: document.getElementById('song-count'),
                listTitle: document.getElementById('list-title'),
                pagination: document.getElementById('pagination-container'),
                roomNameDisplay: document.getElementById('current-room-name'),
                roomInputPort: document.getElementById('room-input-port'),
                roomButtonsContainer: document.getElementById('room-buttons-container'),
                inputs: {
                    singer: document.getElementById('input-singer'),
                    work: document.getElementById('input-work'),
                    artist: document.getElementById('input-artist'),
                    song: document.getElementById('input-song'),
                    partDivision: document.getElementById('input-part-division'),
                    practicing: document.getElementById('input-practicing'),
                    reviewNeeded: document.getElementById('input-review-needed'),
                    isPrivate: document.getElementById('input-private'),
                    viewPassword: document.getElementById('input-view-password')
                },
                privatePasswordContainer: document.getElementById('private-password-container'),
                filterViewPassword: document.getElementById('filter-view-password'),
                searchInput: document.getElementById('list-search-input'),
                searchClearBtn: document.getElementById('search-clear-btn'),
                form: {
                    container: document.getElementById('input-form-container'),
                    titleText: document.getElementById('form-title-text'),
                    icon: document.getElementById('form-icon'),
                    submitBtn: document.getElementById('submit-btn'),
                    cancelBtn: document.getElementById('cancel-edit-btn')
                },
                modals: { 
                    dialog: document.getElementById('custom-dialog'),
                    room: document.getElementById('room-dialog'),
                    csv: document.getElementById('csv-dialog')
                },
                status: document.getElementById('status-message'),
                refreshIcon: document.getElementById('refresh-icon')
            };

            function render() {
                localStorage.setItem('myMusicList', JSON.stringify(songs));
                const uniqueSingers = [...new Set(songs.map(s => s.singer).filter(Boolean))];
                
                if (!els.singerFilterSelect.innerHTML.includes(`value="${activeTab}"`) || els.singerFilterSelect.options.length !== uniqueSingers.length + 1) {
                    let optionsHtml = `<option value="ALL">全ての歌唱者を表示 (${songs.length})</option>`;
                    uniqueSingers.forEach(singer => {
                        const count = songs.filter(s => s.singer === singer).length;
                        optionsHtml += `<option value="${singer}">${singer} (${count})</option>`;
                    });
                    els.singerFilterSelect.innerHTML = optionsHtml;
                    els.singerFilterSelect.value = activeTab;
                }
                
                els.singerCountDisplay.innerText = `登録数: ${uniqueSingers.length}人`;

                const roomName = ROOMS[targetPort] ? ROOMS[targetPort] : 'カスタム部屋';
                els.roomNameDisplay.innerText = `${roomName} (${targetPort})`;

                // フィルターロジック
                const currentViewPassword = els.filterViewPassword.value.trim();
                
                let filteredSongs = songs.filter(s => {
                    // 非公開曲の表示判定
                    if (s.isPrivate) {
                        if (!currentViewPassword || s.viewPassword !== currentViewPassword) {
                            return false; // パスワード不一致または未入力なら非表示
                        }
                    }
                    return true;
                });

                if (activeTab !== 'ALL') {
                    filteredSongs = filteredSongs.filter(s => s.singer === activeTab);
                }
                if (searchQuery) {
                    const queries = searchQuery.toLowerCase().replace(/　/g, ' ').split(' ').filter(q => q);
                    filteredSongs = filteredSongs.filter(s => {
                        const targetText = `${s.song} ${s.work} ${s.artist}`.toLowerCase();
                        return queries.every(q => targetText.includes(q));
                    });
                }
                if (filterTags.isPartDivision) filteredSongs = filteredSongs.filter(s => s.isPartDivision);
                if (filterTags.isPracticing) filteredSongs = filteredSongs.filter(s => s.isPracticing);
                if (filterTags.isReviewNeeded) filteredSongs = filteredSongs.filter(s => s.isReviewNeeded);

                const displayList = [...filteredSongs].reverse();

                const totalPages = Math.ceil(displayList.length / ITEMS_PER_PAGE) || 1;
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIdx = startIdx + ITEMS_PER_PAGE;
                const displaySongs = displayList.slice(startIdx, endIdx);

                els.songCount.innerText = `${displayList.length} tracks`;
                els.listTitle.innerHTML = activeTab === 'ALL' ? '<i data-lucide="list-plus" class="w-5 h-5"></i> All Songs' : `<i data-lucide="user" class="w-5 h-5"></i> ${activeTab}`;

                if (displaySongs.length === 0) {
                    els.songList.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400 gap-2 min-h-[200px]"><i data-lucide="disc" class="w-12 h-12 opacity-20"></i><p class="text-sm">No songs found.</p></div>`;
                } else {
                    els.songList.innerHTML = displaySongs.map((song, i) => {
                        // 全体リスト内でのインデックス（1始まり）を計算して表示する
                        const displayIndex = songs.indexOf(song) + 1;
                        
                        // 検索URL用のパラメータクリーニング (作品名の末尾の()や【】を消す)
                        const cleanWork = (song.work || '').replace(/\s*[\(（【~～].*$/, '').trim();
                        // 検索条件は 曲名 + 作品名 のみにする (歌手名は不要)
                        const searchParam = encodeURIComponent((song.song + ' ' + cleanWork).trim());
                        
                        // ポート番号と検索方式によるURLの切り替え
                        let searchUrl = '';
                        let currentEngine = targetSearchType;
                        // 特定の部屋は強制的にEverything検索にする
                        if (targetPort === 11058 || targetPort === 11060) {
                            currentEngine = 'everything';
                        }

                        if (currentEngine === 'everything') {
                            searchUrl = `http://ykr.moe:${targetPort}/search.php?searchword=${searchParam}`;
                        } else {
                            searchUrl = `http://ykr.moe:${targetPort}/search_listerdb_filelist.php?anyword=${searchParam}`;
                        }
                        
                        let labels = '';
                        if (song.isPartDivision) labels += '<span class="text-red-500 font-bold text-[10px] md:text-xs ml-1 break-keep">(パート分け)</span>';
                        if (song.isPracticing) labels += '<span class="text-blue-600 font-bold text-[10px] md:text-xs ml-1 break-keep">(練習中)</span>';
                        if (song.isReviewNeeded) labels += '<span class="text-yellow-600 font-bold text-[10px] md:text-xs ml-1 break-keep">(要復習)</span>';
                        if (song.isPrivate) labels += '<span class="text-gray-400 opacity-80 text-[10px] md:text-xs ml-1 font-normal break-keep">(非公開)</span>';

                        const isEditing = song.id === editingId;
                        const rowClass = isEditing ? 'bg-blue-50 border-blue-300' : 'bg-white border-gray-100 hover:shadow-md hover:border-blue-200';

                        return `
                        <div class="group grid grid-cols-12 gap-2 md:gap-4 px-2 md:px-4 py-3 mb-1 items-center border rounded-lg transition-all duration-200 ${rowClass}">
                            <div class="col-span-1 text-center text-gray-400 font-mono text-xs md:text-sm group-hover:text-blue-500">${displayIndex}</div>
                            <!-- 曲名サイズを text-xs md:text-sm に修正（小さく） -->
                            <div class="col-span-4 md:col-span-5 min-w-0"><div class="font-bold text-gray-800 text-sm md:text-base break-words whitespace-normal leading-tight">${song.song}${labels}</div></div>
                            <div class="col-span-4 md:col-span-4 min-w-0 flex flex-col justify-center pr-8">
                                <div class="text-[10px] md:text-xs text-gray-600 flex items-center gap-1 flex-wrap"><i data-lucide="mic" class="w-3 h-3 text-gray-400 flex-shrink-0"></i><span class="break-words whitespace-normal leading-tight">${song.singer || '-'}</span></div>
                                <div class="text-[10px] text-gray-400 mt-0.5 break-words whitespace-normal leading-tight">${song.artist || ''} ${song.work ? '/ ' + song.work : ''}</div>
                            </div>
                            <div class="col-span-3 md:col-span-2 flex justify-end items-center gap-1 md:gap-2">
                                <a href="${searchUrl}" target="_self" rel="noopener noreferrer" class="p-1.5 md:p-2 bg-green-50 text-green-600 hover:bg-green-100 rounded-lg transition-colors border border-green-200 shadow-sm flex-shrink-0" title="検索"><i data-lucide="search" class="w-3.5 h-3.5 md:w-4 md:h-4"></i></a>
                                <div class="flex items-center gap-0.5 md:gap-1 opacity-100 transition-opacity">
                                    <button onclick="app.editSong(${song.id})" class="p-1.5 md:p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="編集"><i data-lucide="edit-3" class="w-3.5 h-3.5 md:w-4 md:h-4"></i></button>
                                    <div class="flex flex-col gap-0.5">
                                        <button onclick="app.moveSong(${song.id}, 'up')" class="p-0.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded"><i data-lucide="arrow-up" class="w-3 h-3"></i></button>
                                        <button onclick="app.moveSong(${song.id}, 'down')" class="p-0.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded"><i data-lucide="arrow-down" class="w-3 h-3"></i></button>
                                    </div>
                                    <button onclick="app.deleteSong(${song.id})" class="p-1.5 md:p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5 md:w-4 md:h-4"></i></button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }

                if (totalPages > 1) {
                    els.pagination.innerHTML = `
                        <button onclick="app.setPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled class="opacity-30"' : 'class="hover:text-blue-600"'}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span class="font-mono text-gray-500">Page ${currentPage} / ${totalPages}</span>
                        <button onclick="app.setPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled class="opacity-30"' : 'class="hover:text-blue-600"'}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    `;
                    els.pagination.classList.remove('hidden');
                } else {
                    els.pagination.classList.add('hidden');
                }
                lucide.createIcons();
            }

            function setActiveTab(tab) { activeTab = tab; currentPage = 1; render(); }
            function setPage(page) { currentPage = page; render(); }
            
            function toggleClearButton(val) {
                if (val.length > 0) els.searchClearBtn.classList.remove('hidden');
                else els.searchClearBtn.classList.add('hidden');
            }
            function triggerSearch() { setSearchQuery(els.searchInput.value); }
            function setSearchQuery(query) { searchQuery = query; currentPage = 1; render(); }
            function clearSearch() { els.searchInput.value = ''; toggleClearButton(''); triggerSearch(); }
            function toggleFilterTag(key) { filterTags[key] = !filterTags[key]; currentPage = 1; render(); }
            function triggerRender() { currentPage = 1; render(); } 

            function togglePrivateInput() {
                if (els.inputs.isPrivate.checked) {
                    els.privatePasswordContainer.classList.remove('hidden');
                } else {
                    els.privatePasswordContainer.classList.add('hidden');
                }
            }

            // 検索方式の切り替え
            function setSearchType(type) {
                targetSearchType = type;
                localStorage.setItem('targetSearchType', type);
                render();
            }

            function openRoomModal() {
                // Radio Button の設定状態を反映
                const radioBtn = document.querySelector(`input[name="search-type"][value="${targetSearchType}"]`);
                if (radioBtn) radioBtn.checked = true;

                let html = '';
                for (const [port, name] of Object.entries(ROOMS)) {
                    const isSelected = parseInt(port) === targetPort;
                    const bgClass = isSelected ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200';
                    html += `<button onclick="app.selectPort(${port})" class="px-3 py-2 rounded-lg text-xs font-bold transition-all ${bgClass}">${name} <span class="opacity-70 text-[10px] block font-normal">${port}</span></button>`;
                }
                els.roomButtonsContainer.innerHTML = html;
                els.roomInputPort.value = targetPort;
                els.modals.room.classList.remove('hidden');
            }
            function closeRoomModal() { els.modals.room.classList.add('hidden'); }
            function selectPort(port) { targetPort = parseInt(port); localStorage.setItem('targetPort', targetPort); closeRoomModal(); render(); }
            function setCustomPort() {
                const port = parseInt(els.roomInputPort.value);
                if (port && port > 0) selectPort(port); else showDialog('有効なポート番号を入力してください', 'alert');
            }

            function saveSong() { 
                const singer = els.inputs.singer.value.trim();
                const songName = els.inputs.song.value.trim();
                if (!songName) { showDialog('曲名は必須です', 'alert'); return; }
                const songData = {
                    singer: singer,
                    work: els.inputs.work.value.trim(),
                    artist: els.inputs.artist.value.trim(),
                    song: songName,
                    isPartDivision: els.inputs.partDivision.checked,
                    isPracticing: els.inputs.practicing.checked,
                    isReviewNeeded: els.inputs.reviewNeeded.checked,
                    isPrivate: els.inputs.isPrivate.checked,
                    viewPassword: els.inputs.viewPassword.value.trim()
                };
                if (editingId) {
                    const index = songs.findIndex(s => s.id === editingId);
                    if (index !== -1) { songs[index] = { ...songs[index], ...songData }; showDialog('曲情報を更新しました。', 'alert'); }
                } else {
                    songs.push({ id: Date.now() + Math.random(), ...songData });
                }
                if (singer) activeTab = singer;
                resetForm();
                render();
            }
            
            function editSong(id) {
                const song = songs.find(s => s.id === id);
                if (!song) return;
                els.inputs.singer.value = song.singer || '';
                els.inputs.work.value = song.work || '';
                els.inputs.artist.value = song.artist || '';
                els.inputs.song.value = song.song || '';
                els.inputs.partDivision.checked = song.isPartDivision || false;
                els.inputs.practicing.checked = song.isPracticing || false;
                els.inputs.reviewNeeded.checked = song.isReviewNeeded || false;
                els.inputs.isPrivate.checked = song.isPrivate || false;
                els.inputs.viewPassword.value = song.viewPassword || '';
                togglePrivateInput();

                editingId = id;
                els.form.titleText.innerText = "登録情報を編集";
                els.form.icon.setAttribute('data-lucide', 'edit-3');
                els.form.submitBtn.innerText = "更新する";
                els.form.submitBtn.className = "w-full py-2.5 mt-2 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]";
                els.form.cancelBtn.classList.remove('hidden');
                els.form.container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                lucide.createIcons();
                render();
            }

            function cancelEdit() { resetForm(); render(); }
            function resetForm() {
                els.inputs.song.value = ''; els.inputs.work.value = ''; els.inputs.artist.value = '';
                els.inputs.partDivision.checked = false; els.inputs.practicing.checked = false; els.inputs.reviewNeeded.checked = false;
                els.inputs.isPrivate.checked = false; els.inputs.viewPassword.value = '';
                togglePrivateInput();
                editingId = null;
                els.form.titleText.innerText = "新規登録";
                els.form.icon.setAttribute('data-lucide', 'plus');
                els.form.submitBtn.innerText = "リストに追加";
                els.form.submitBtn.className = "w-full py-2.5 mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]";
                els.form.cancelBtn.classList.add('hidden');
                lucide.createIcons();
            }
            function addSong() { saveSong(); }

            function deleteSong(id) {
                showDialog('本当に削除しますか？', 'confirm', () => {
                    songs = songs.filter(s => s.id !== id);
                    if (!deletedIds.includes(id)) { deletedIds.push(id); localStorage.setItem('deletedIds', JSON.stringify(deletedIds)); }
                    if (editingId === id) cancelEdit();
                    render();
                });
            }

            function moveSong(id, direction) {
                const globalIndex = songs.findIndex(s => s.id === id);
                if (globalIndex === -1) return;

                // フィルターされたリスト上での位置関係を取得
                const currentViewPassword = els.filterViewPassword.value.trim();
                let currentList = songs.filter(s => {
                    if (s.isPrivate && (!currentViewPassword || s.viewPassword !== currentViewPassword)) return false;
                    return true;
                });
                
                if (activeTab !== 'ALL') currentList = currentList.filter(s => s.singer === activeTab);
                if (searchQuery) {
                     const queries = searchQuery.toLowerCase().replace(/　/g, ' ').split(' ').filter(q => q);
                     currentList = currentList.filter(s => { const targetText = `${s.song} ${s.work} ${s.artist}`.toLowerCase(); return queries.every(q => targetText.includes(q)); });
                }
                if (filterTags.isPartDivision) currentList = currentList.filter(s => s.isPartDivision);
                if (filterTags.isPracticing) currentList = currentList.filter(s => s.isPracticing);
                if (filterTags.isReviewNeeded) currentList = currentList.filter(s => s.isReviewNeeded);

                const visualIndex = currentList.findIndex(s => s.id === id);
                if (visualIndex === -1) return;
                let targetVisualIndex = -1;
                // Old-New list, visual Up is index+1
                if (direction === 'up' && visualIndex < currentList.length - 1) targetVisualIndex = visualIndex + 1;
                if (direction === 'down' && visualIndex > 0) targetVisualIndex = visualIndex - 1;

                if (targetVisualIndex !== -1) {
                    const swapSong = currentList[targetVisualIndex];
                    const swapGlobalIndex = songs.findIndex(s => s.id === swapSong.id);
                    [songs[globalIndex], songs[swapGlobalIndex]] = [songs[swapGlobalIndex], songs[globalIndex]];
                    render();
                }
            }

            function openCSVModal() { els.modals.csv.classList.remove('hidden'); }
            function closeCSVModal() { els.modals.csv.classList.add('hidden'); }
            
            function exportCSV(withData = true) {
                const BOM = '\uFEFF';
                const header = ['歌唱者', '作品名', '歌手', '曲名', 'パート分け', '練習中', '要復習'];
                const csvRows = [header.join(',')];
                
                if (withData) {
                    // 非公開の曲はエクスポートしない
                    const exportableSongs = songs.filter(s => !s.isPrivate);
                    exportableSongs.forEach(s => {
                        const row = [ s.singer||'', s.work||'', s.artist||'', s.song||'', s.isPartDivision?'1':'', s.isPracticing?'1':'', s.isReviewNeeded?'1':'' ].map(field => {
                            const stringField = String(field);
                            return (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) ? `"${stringField.replace(/"/g, '""')}"` : stringField;
                        });
                        csvRows.push(row.join(','));
                    });
                }

                const csvString = BOM + csvRows.join('\r\n');
                const blob = new Blob([csvString], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = withData 
                    ? `karaoke_list_backup_${new Date().toISOString().slice(0,10)}.csv` 
                    : `karaoke_list_template.csv`;
                a.click();
                URL.revokeObjectURL(url);
                closeCSVModal();
            }

            function handleJSONImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            showDialog(`ファイルから ${importedData.length} 件のデータを読み込みました (JSON)。\n反映するには「同期して保存」を押してください。\n(次回保存時にサーバーのデータを完全に上書きします)`, 'alert');
                            songs = importedData;
                            forceOverwriteMode = true; // Enable overwrite mode
                            render();
                        } else { showDialog('JSONデータの形式が正しくありません。', 'alert'); }
                    } catch (error) { showDialog('ファイルの読み込みに失敗しました。', 'alert'); }
                };
                reader.readAsText(file);
                input.value = '';
            }

            function handleCSVImport(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        importCSV(text);
                    } catch (error) { showDialog('ファイルの読み込みに失敗しました。', 'alert'); }
                };
                reader.readAsText(file);
                input.value = '';
                closeCSVModal();
            }

            function normalizeStr(str) {
                if (!str) return '';
                return str.normalize('NFKC').replace(/[\s\u3000]+/g, ' ').trim();
            }

            function importCSV(csvText) {
                const rows = csvText.split(/\r\n|\n/);
                const dataRows = rows.slice(1).filter(r => r.trim() !== '');
                let addedCount = 0, updatedCount = 0;
                
                dataRows.forEach(rowStr => {
                    let row = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let i = 0; i < rowStr.length; i++) {
                        const char = rowStr[i];
                        if (char === '"') {
                            if (i + 1 < rowStr.length && rowStr[i + 1] === '"') { currentField += '"'; i++; } 
                            else { inQuote = !inQuote; }
                        } else if (char === ',' && !inQuote) {
                            row.push(currentField); currentField = '';
                        } else { currentField += char; }
                    }
                    row.push(currentField);
                    row = row.map(f => f.trim()); 

                    if (row.length < 4) return;

                    const newSinger = row[0];
                    const newWork = row[1];
                    const newArtist = row[2];
                    let newSong = row[3];
                    if (!newSong) return;

                    let isPart = (row[4] === '1' || row[4]?.toLowerCase() === 'true');
                    let isPrac = (row[5] === '1' || row[5]?.toLowerCase() === 'true');
                    let isRev = (row[6] === '1' || row[6]?.toLowerCase() === 'true');

                    const patterns = [
                        { regex: /[\(（]パート分け[\)）]/, key: 'part' },
                        { regex: /[\(（]練習中[\)）]/, key: 'prac' },
                        { regex: /[\(（]要復習[\)）]/, key: 'rev' }
                    ];

                    patterns.forEach(p => {
                        if (p.regex.test(newSong)) {
                            if (p.key === 'part') isPart = true;
                            if (p.key === 'prac') isPrac = true;
                            if (p.key === 'rev') isRev = true;
                            newSong = newSong.replace(p.regex, '').trim();
                        }
                    });
                    
                    const normSinger = normalizeStr(newSinger);
                    const normSong = normalizeStr(newSong);

                    const existingIndex = songs.findIndex(s => 
                        normalizeStr(s.singer) === normSinger && 
                        normalizeStr(s.song) === normSong
                    );

                    if (existingIndex !== -1) {
                        // 既存データの更新（非公開設定などのCSVにない情報は保持する）
                        songs[existingIndex] = { ...songs[existingIndex], work: newWork, artist: newArtist, isPartDivision: isPart, isPracticing: isPrac, isReviewNeeded: isRev };
                        updatedCount++;
                    } else {
                        // 新規追加
                        songs.push({ id: Date.now() + Math.random(), singer: newSinger, work: newWork, artist: newArtist, song: newSong, isPartDivision: isPart, isPracticing: isPrac, isReviewNeeded: isRev, isPrivate: false, viewPassword: '' });
                        addedCount++;
                    }
                });
                showDialog(`CSVインポート完了:\n追加: ${addedCount}件\n更新: ${updatedCount}件\n反映するには「同期して保存」を押してください。`, 'alert');
                render();
            }

            async function saveToGAS() {
                if (!GAS_API_URL) { showDialog('GASのURLが設定されていません。', 'alert'); return; }
                if (songs.length < 3 && !forceOverwriteMode) { // Safety check against wiping out data with empty list (unless restoring)
                    const isInitial = JSON.stringify(songs) === JSON.stringify(initialData);
                    if(isInitial) {
                         showDialog('初期データのため保存を中止しました。データを入力してください。', 'alert'); return;
                    }
                }
                updateStatus('サーバーと同期中...', true);
                
                try {
                    let mergedSongs = songs;

                    if (!forceOverwriteMode) {
                        // Normal mode: Fetch and Merge
                        let serverSongs = [];
                        try {
                            const res = await fetch(GAS_API_URL + '?t=' + new Date().getTime());
                            if (!res.ok) throw new Error('Fetch failed');
                            const text = await res.text();
                            const data = JSON.parse(text);
                            if (Array.isArray(data)) serverSongs = data;
                        } catch(e) { 
                            showDialog('サーバーからのデータ取得に失敗しました。保存を中止します。\n(インターネット接続やGASの状態を確認してください)', 'alert');
                            updateStatus('保存中止');
                            return; // Stop saving if fetch failed
                        }

                        const localIds = new Set(songs.map(s => s.id));
                        const newServerSongs = serverSongs.filter(s => !localIds.has(s.id) && !deletedIds.includes(s.id));
                        mergedSongs = [...songs, ...newServerSongs];
                    } else {
                        // Overwrite mode (after JSON restore): Use local songs as is
                        console.log('Force overwrite mode active');
                    }

                    songs = mergedSongs; render();
                    
                    // GAS Save
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(mergedSongs), headers: { "Content-Type": "text/plain;charset=utf-8" } });
                    
                    // GitHub Backup (if configured)
                    if (githubConfig.token && githubConfig.repo) {
                        saveToGitHub(mergedSongs);
                    }

                    deletedIds = []; localStorage.setItem('deletedIds', JSON.stringify(deletedIds));
                    forceOverwriteMode = false; // Reset mode
                    updateStatus('同期・保存完了！'); setTimeout(() => updateStatus(''), 3000);

                } catch (error) { showDialog(`保存エラー: ${error.message}\nGASのデプロイ設定を確認してください。`, 'alert'); updateStatus('保存失敗'); }
            }

            async function saveToGitHub(data) {
                const { token, owner, repo, path } = githubConfig;
                const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                
                try {
                    // Get SHA
                    let sha = null;
                    try {
                        const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                        if (res.ok) { const json = await res.json(); sha = json.sha; }
                    } catch(e) {}

                    // Put
                    await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Backup via WebApp ${new Date().toLocaleString()}`,
                            content: content,
                            sha: sha
                        })
                    });
                    console.log('GitHub backup success');
                } catch(e) {
                    console.error('GitHub backup failed', e);
                }
            }

            async function loadFromGAS(silent = false) {
                if (!GAS_API_URL) { if(!silent) showDialog('GASのURLが設定されていません。', 'alert'); return; }
                const runLoad = async () => {
                    updateStatus('読み込み中...', true);
                    try {
                        const res = await fetch(GAS_API_URL + '?t=' + new Date().getTime());
                        const text = await res.text();
                        let data;
                        try { data = JSON.parse(text); } catch(e) { throw new Error("サーバーからの応答が不正です。"); }
                        if (Array.isArray(data)) {
                            songs = data; deletedIds = []; localStorage.setItem('deletedIds', JSON.stringify(deletedIds));
                            activeTab = 'ALL'; currentPage = 1; render();
                            updateStatus('読み込み完了'); setTimeout(() => updateStatus(''), 3000);
                        } else { throw new Error('データ形式が不正です'); }
                    } catch (error) {
                        if(!silent) showDialog(`【通信エラー】\n${error.message}`, 'alert'); updateStatus('エラー');
                    }
                };
                if (silent) await runLoad(); else showDialog('サーバーからデータを読み込みますか？\nローカルの変更は上書きされます。', 'confirm', runLoad);
            }

            function updateStatus(msg, animate = false) {
                els.status.innerText = msg;
                animate ? els.status.classList.add('animate-pulse') : els.status.classList.remove('animate-pulse');
                if (els.refreshIcon) els.refreshIcon.classList.remove('animate-spin-slow');
            }

            function showDialog(message, type = 'alert', onConfirm = null) {
                const d = els.modals.dialog;
                document.getElementById('dialog-message').innerText = message;
                const actions = document.getElementById('dialog-actions');
                actions.innerHTML = '';
                const close = () => d.classList.add('hidden');
                if (type === 'confirm') {
                    actions.innerHTML = `<button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg text-sm font-bold">キャンセル</button><button id="confirm-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">OK</button>`;
                    document.getElementById('confirm-ok-btn').onclick = () => { close(); if(onConfirm) onConfirm(); };
                } else {
                    actions.innerHTML = `<button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold w-full">OK</button>`;
                }
                d.classList.remove('hidden');
            }

            const isInitialData = JSON.stringify(songs) === JSON.stringify(initialData);
            if (GAS_API_URL && (!storedData || isInitialData)) loadFromGAS(true);
            render();

            return {
                addSong, deleteSong, moveSong, setActiveTab, setPage,
                saveToGAS, loadFromGAS, handleJSONImport, handleCSVImport, triggerSearch, setSearchQuery, toggleClearButton, clearSearch,
                openRoomModal, closeRoomModal, selectPort, setCustomPort, saveSong, editSong, cancelEdit, toggleFilterTag,
                openCSVModal, closeCSVModal, exportCSV, triggerRender, togglePrivateInput, setSearchType
            };
        })();
    </script>
</body>
</html>
