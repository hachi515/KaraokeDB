<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マイリスト登録</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin 1s linear infinite;
        }
        
        /* Background Pattern */
        .bg-pattern {
            background-color: #f3f4f6;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen relative pb-20">

    <!-- Background -->
    <div class="fixed inset-0 z-0 bg-pattern"></div>

    <!-- Main Container -->
    <div class="relative z-10 max-w-5xl mx-auto pt-6 px-4">
        
        <!-- Header -->
        <div class="bg-white/90 backdrop-blur-md rounded-t-2xl shadow-sm border-b border-gray-200 p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-500 rounded-lg text-white">
                    <i data-lucide="music"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">マイリスト登録</h1>
                    <p class="text-xs text-gray-500">My Setlist Database</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="app.loadFromGAS()" class="flex items-center gap-1.5 px-3 py-2 text-xs font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-100 shadow-sm" title="サーバーから最新データを取得して更新">
                    <i data-lucide="refresh-cw" class="w-3.5 h-3.5" id="refresh-icon"></i>
                    <span>データ更新</span>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="bg-white/80 backdrop-blur-sm shadow-xl min-h-[600px] flex flex-col md:flex-row">
            
            <!-- Left Column: Input & Singer List -->
            <div class="w-full md:w-80 bg-white/50 border-r border-gray-200 p-6 flex flex-col gap-6">
                
                <!-- Input Form -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative transition-all duration-300" id="input-form-container">
                    <h2 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2" id="form-title">
                        <i data-lucide="plus" class="text-blue-500 w-4 h-4" id="form-icon"></i> <span id="form-title-text">新規登録</span>
                    </h2>
                    
                    <!-- Cancel Edit Button (Hidden by default) -->
                    <button onclick="app.cancelEdit()" id="cancel-edit-btn" class="hidden absolute top-4 right-4 text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1">
                        <i data-lucide="x" class="w-3 h-3"></i> キャンセル
                    </button>

                    <div class="space-y-3">
                        <div class="relative">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Singer</label>
                            <input type="text" id="input-singer" list="singer-options" placeholder="歌唱者名を入力または選択"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                            <datalist id="singer-options"></datalist>
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Info</label>
                            <input type="text" id="input-work" placeholder="作品名"
                                class="w-full px-3 py-2 mb-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                            <input type="text" id="input-artist" placeholder="歌手名"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                        </div>

                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Song</label>
                            <input type="text" id="input-song" placeholder="曲名 (必須)"
                                class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                        </div>

                        <!-- Checkboxes: Tags -->
                        <div class="flex flex-wrap items-center gap-4 pt-1">
                            <!-- Part Division -->
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-part-division" class="w-4 h-4 text-red-500 bg-gray-50 border-gray-300 rounded focus:ring-red-400 cursor-pointer">
                                <label for="input-part-division" class="text-xs text-gray-600 cursor-pointer select-none font-medium">パート分け</label>
                            </div>
                            <!-- Practicing -->
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-practicing" class="w-4 h-4 text-blue-500 bg-gray-50 border-gray-300 rounded focus:ring-blue-400 cursor-pointer">
                                <label for="input-practicing" class="text-xs text-gray-600 cursor-pointer select-none font-medium">練習中</label>
                            </div>
                            <!-- Review Needed -->
                            <div class="flex items-center gap-1.5">
                                <input type="checkbox" id="input-review-needed" class="w-4 h-4 text-yellow-500 bg-gray-50 border-gray-300 rounded focus:ring-yellow-400 cursor-pointer">
                                <label for="input-review-needed" class="text-xs text-gray-600 cursor-pointer select-none font-medium">要復習</label>
                            </div>
                        </div>

                        <button onclick="app.saveSong()" id="submit-btn" class="w-full py-2.5 mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]">
                            リストに追加
                        </button>
                    </div>
                </div>

                <!-- Singer Filter & Search -->
                <div class="flex-1 flex flex-col">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">表示フィルター</h3>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 space-y-4">
                        
                        <!-- Singer Select -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">歌唱者を選択</label>
                            <div class="relative">
                                <select id="singer-filter-select" onchange="app.setActiveTab(this.value)" 
                                    class="w-full pl-3 pr-10 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 cursor-pointer">
                                    <option value="ALL">全ての歌唱者を表示</option>
                                    <!-- Options will be injected here -->
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500">
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-gray-400 text-right" id="singer-count-display">
                                <!-- Count display -->
                            </div>
                        </div>

                        <!-- Search Box (Modified) -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">リスト内検索</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="list-search-input" placeholder="スペースでAND検索" onkeydown="if(event.key==='Enter') app.triggerSearch()"
                                        class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all">
                                </div>
                                <button onclick="app.triggerSearch()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-lg transition-colors flex items-center gap-1 text-sm font-bold active:scale-95">
                                    <i data-lucide="search" class="w-4 h-4"></i>
                                    検索
                                </button>
                            </div>
                        </div>

                        <!-- Target Port Selection -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">検索先の機材係 (部屋)</label>
                            <button onclick="app.openRoomModal()" id="current-room-btn"
                                class="w-full text-left px-3 py-2 bg-green-50 border border-green-200 hover:bg-green-100 text-green-700 rounded-lg text-xs font-bold flex items-center justify-between transition-colors">
                                <span><i data-lucide="monitor" class="w-3 h-3 inline mr-1"></i> <span id="current-room-name">つぼはち部屋 (11059)</span></span>
                                <i data-lucide="chevron-right" class="w-3 h-3"></i>
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Right Column: Song List -->
            <div class="flex-1 flex flex-col min-h-[500px]">
                <!-- Toolbar -->
                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white/50">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2" id="list-title">
                        <i data-lucide="list-plus"></i> All Songs
                    </h2>
                    <div class="text-xs text-gray-500" id="song-count">0 tracks</div>
                </div>

                <!-- Header -->
                <div class="grid grid-cols-12 gap-2 md:gap-4 px-2 md:px-6 py-2 bg-gray-50/50 text-[10px] font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100">
                    <div class="col-span-1 text-center">No.</div>
                    <div class="col-span-4 md:col-span-5">Song Title</div>
                    <div class="col-span-4 md:col-span-4">Information</div>
                    <div class="col-span-3 md:col-span-2 text-right">Action</div>
                </div>

                <!-- List Body -->
                <div id="song-list-container" class="flex-1 overflow-y-auto bg-white/30 custom-scrollbar p-2">
                    <!-- Dynamic Content -->
                </div>

                <!-- Pagination -->
                <div id="pagination-container" class="p-3 border-t border-gray-100 bg-white/50 flex justify-center items-center gap-4 text-sm">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-white/90 backdrop-blur-md rounded-b-2xl shadow-sm border-t border-gray-200 p-4 flex justify-between items-center gap-2">
             <div class="flex-1 text-xs text-gray-400 font-mono flex items-center gap-2" id="status-message">
                <!-- Status text -->
             </div>
             
             <!-- Migration Import Button -->
             <input type="file" id="file-import" class="hidden" accept=".json" onchange="app.importFile(this)">
             <button onclick="document.getElementById('file-import').click()" 
                class="flex items-center gap-2 px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded-full font-bold transition-colors active:scale-95" title="JSONファイルを読み込む">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                <span class="hidden sm:inline">取込</span>
             </button>

             <button onclick="app.saveToGAS()"
                class="flex items-center gap-2 px-6 py-2.5 bg-gray-800 hover:bg-gray-900 text-white rounded-full font-bold shadow-lg shadow-gray-400/20 transition-all transform hover:-translate-y-0.5 active:scale-95">
                <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                <span>同期して保存</span>
             </button>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Custom Dialog (Alert/Confirm replacement) -->
    <div id="custom-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative modal-animate text-center">
            <div id="dialog-icon" class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-blue-100 text-blue-500 mb-4">
                <i data-lucide="info"></i>
            </div>
            <p id="dialog-message" class="text-sm text-gray-700 font-medium mb-6 whitespace-pre-wrap"></p>
            <div id="dialog-actions" class="flex gap-2 justify-center">
                <!-- Buttons injected via JS -->
            </div>
        </div>
    </div>

    <!-- Room Selection Modal -->
    <div id="room-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 relative modal-animate flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="monitor" class="text-green-500"></i> 機材係 (部屋) 選択
                </h3>
                <button onclick="app.closeRoomModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
            </div>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">ポート番号を直接入力 (任意)</label>
                <div class="flex gap-2">
                    <input type="number" id="room-input-port" placeholder="11059" class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-500">
                    <button onclick="app.setCustomPort()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg whitespace-nowrap">設定</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar border-t border-gray-100 pt-4">
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2" id="room-buttons-container">
                    <!-- Buttons injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = (() => {
            // ▼▼▼ GASのウェブアプリURL (設定済み) ▼▼▼
            const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwhx-_zhE7IJvRLgOegHpQ5WYqC6cBG3fENWtMa0sEX0Rwnh__dPoS25OPkkU9xvIDp/exec'; 
            // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

            const ITEMS_PER_PAGE = 10;
            const initialData = [
                { id: 1, singer: '月見ヤチヨ', work: 'Orbit', artist: 'yuigot', song: 'Remember' },
                { id: 2, singer: '月見ヤチヨ', work: 'Orbit', artist: 'Aqu3ra', song: '星降る海' },
                { id: 3, singer: 'V.A.', work: 'Compilation', artist: 'Unknown', song: '私は、わたしの事が好き。' },
            ];

            const ROOMS = {
                11000: "ゆーふうりん部屋", 11001: "ゆーふうりん部屋", 11002: "ゆーふうりん部屋", 11003: "ゆーふうりん部屋", 11004: "ゆーふうりん部屋",
                11005: "ゆーふうりん部屋", 11006: "ゆーふうりん部屋", 11007: "ゆーふうりん部屋", 11008: "ゆーふうりん部屋", 11009: "ゆーふうりん部屋",
                11012: "加古部屋", 11021: "成田部屋", 11022: "成田部屋", 11028: "タマ部屋", 11058: "すみた部屋", 11059: "つぼはち部屋",
                11063: "なぎ部屋", 11064: "naoo部屋", 11066: "芝ちゃん部屋", 11067: "crom部屋", 11068: "けんしん部屋", 11069: "けんちぃ部屋",
                11070: "黒河部屋", 11071: "黒河部屋", 11074: "tukinowa部屋", 11077: "v3部屋", 11078: "のんでるん部屋", 11079: "まどか部屋",
                11084: "タカヒロ部屋", 11085: "タカヒロ部屋", 11086: "タカヒロ部屋", 11087: "MiO部屋", 11088: "ほっしー部屋",
                11091: "千秋部屋", 11092: "ヒロ部屋", 11101: "えみち部屋", 11102: "るえ部屋", 11103: "ながし部屋", 11104: "MrN部屋",
                11105: "ヤマテル部屋", 11106: "冨塚部屋", 11107: "ブルーベリー部屋", 11108: "コタ部屋", 11109: "姫部屋"
            };

            // Local Storage Logic
            let storedData = localStorage.getItem('myMusicList');
            let songs = storedData ? JSON.parse(storedData) : initialData;
            
            let deletedIds = JSON.parse(localStorage.getItem('deletedIds')) || [];
            let activeTab = 'ALL';
            let searchQuery = '';
            let targetPort = parseInt(localStorage.getItem('targetPort')) || 11059;
            let currentPage = 1;
            let editingId = null; 

            const els = {
                singerFilterSelect: document.getElementById('singer-filter-select'),
                singerCountDisplay: document.getElementById('singer-count-display'),
                songList: document.getElementById('song-list-container'),
                songCount: document.getElementById('song-count'),
                listTitle: document.getElementById('list-title'),
                singerOptions: document.getElementById('singer-options'),
                pagination: document.getElementById('pagination-container'),
                roomNameDisplay: document.getElementById('current-room-name'),
                roomInputPort: document.getElementById('room-input-port'),
                roomButtonsContainer: document.getElementById('room-buttons-container'),
                inputs: {
                    singer: document.getElementById('input-singer'),
                    work: document.getElementById('input-work'),
                    artist: document.getElementById('input-artist'),
                    song: document.getElementById('input-song'),
                    partDivision: document.getElementById('input-part-division'),
                    practicing: document.getElementById('input-practicing'),
                    reviewNeeded: document.getElementById('input-review-needed')
                },
                searchInput: document.getElementById('list-search-input'), // New
                form: {
                    container: document.getElementById('input-form-container'),
                    titleText: document.getElementById('form-title-text'),
                    icon: document.getElementById('form-icon'),
                    submitBtn: document.getElementById('submit-btn'),
                    cancelBtn: document.getElementById('cancel-edit-btn')
                },
                modals: { 
                    dialog: document.getElementById('custom-dialog'),
                    room: document.getElementById('room-dialog')
                },
                status: document.getElementById('status-message'),
                refreshIcon: document.getElementById('refresh-icon')
            };

            // --- Core Functions ---
            
            function render() {
                localStorage.setItem('myMusicList', JSON.stringify(songs));
                const uniqueSingers = [...new Set(songs.map(s => s.singer).filter(Boolean))];
                
                // Update Dropdown
                if (!els.singerFilterSelect.innerHTML.includes(`value="${activeTab}"`) || els.singerFilterSelect.options.length !== uniqueSingers.length + 1) {
                    let optionsHtml = `<option value="ALL">全ての歌唱者を表示 (${songs.length})</option>`;
                    uniqueSingers.forEach(singer => {
                        const count = songs.filter(s => s.singer === singer).length;
                        optionsHtml += `<option value="${singer}">${singer} (${count})</option>`;
                    });
                    els.singerFilterSelect.innerHTML = optionsHtml;
                    els.singerFilterSelect.value = activeTab;
                }
                
                els.singerCountDisplay.innerText = `登録数: ${uniqueSingers.length}人`;
                els.singerOptions.innerHTML = uniqueSingers.map(s => `<option value="${s}"></option>`).join('');

                // Update Room Display
                const roomName = ROOMS[targetPort] ? ROOMS[targetPort] : 'カスタム部屋';
                els.roomNameDisplay.innerText = `${roomName} (${targetPort})`;

                // Filter Logic
                let filteredSongs = songs;
                if (activeTab !== 'ALL') {
                    filteredSongs = filteredSongs.filter(s => s.singer === activeTab);
                }
                if (searchQuery) {
                    const queries = searchQuery.toLowerCase().replace(/　/g, ' ').split(' ').filter(q => q);
                    filteredSongs = filteredSongs.filter(s => {
                        const targetText = `${s.song} ${s.work} ${s.artist}`.toLowerCase();
                        return queries.every(q => targetText.includes(q));
                    });
                }

                // Display Order: Reverse (Newest First)
                // Note: filteredSongs currently in [Old ... New] order (Registration order)
                // We reverse it to display Newest at top.
                // However, we want "No." to reflect original registration sequence.
                // So "No.1" is the oldest item.
                const displayList = [...filteredSongs].reverse();

                // Pagination
                const totalPages = Math.ceil(displayList.length / ITEMS_PER_PAGE) || 1;
                
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIdx = startIdx + ITEMS_PER_PAGE;
                const displaySongs = displayList.slice(startIdx, endIdx);

                els.songCount.innerText = `${displayList.length} tracks`;
                els.listTitle.innerHTML = activeTab === 'ALL' 
                    ? '<i data-lucide="list-plus" class="w-5 h-5"></i> All Songs' 
                    : `<i data-lucide="user" class="w-5 h-5"></i> ${activeTab}`;

                if (displaySongs.length === 0) {
                    els.songList.innerHTML = `
                        <div class="h-full flex flex-col items-center justify-center text-gray-400 gap-2 min-h-[200px]">
                            <i data-lucide="disc" class="w-12 h-12 opacity-20"></i>
                            <p class="text-sm">No songs found.</p>
                        </div>
                    `;
                } else {
                    els.songList.innerHTML = displaySongs.map((song, i) => {
                        // Calculate No. based on original filtered list length
                        // Display List is Reversed.
                        // Top item on Page 1 (Newest) should be No. MAX
                        // Formula: Total Filtered Count - (Index in Display List)
                        // Index in Display List = startIdx + i
                        const displayIndex = filteredSongs.length - (startIdx + i);
                        
                        const searchParam = encodeURIComponent((song.song + ' ' + (song.work||'') + ' ' + (song.artist||'')).trim());
                        const searchUrl = `http://ykr.moe:${targetPort}/search_listerdb_filelist.php?anyword=${searchParam}`;
                        
                        // Labels
                        let labels = '';
                        if (song.isPartDivision) labels += '<span class="text-red-400 opacity-80 text-xs ml-1 font-normal break-keep">(パート分け)</span>';
                        if (song.isPracticing) labels += '<span class="text-blue-500 opacity-80 text-xs ml-1 font-normal break-keep">(練習中)</span>';
                        if (song.isReviewNeeded) labels += '<span class="text-yellow-600 opacity-90 text-xs ml-1 font-normal break-keep">(要復習)</span>';

                        const isEditing = song.id === editingId;
                        const rowClass = isEditing ? 'bg-blue-50 border-blue-300' : 'bg-white border-gray-100 hover:shadow-md hover:border-blue-200';

                        return `
                        <div class="group grid grid-cols-12 gap-2 md:gap-4 px-2 md:px-4 py-3 mb-1 items-center border rounded-lg transition-all duration-200 ${rowClass}">
                            <div class="col-span-1 text-center text-gray-400 font-mono text-xs md:text-sm group-hover:text-blue-500">
                                ${displayIndex}
                            </div>
                            <div class="col-span-4 md:col-span-5 min-w-0">
                                <div class="font-bold text-gray-800 text-xs md:text-sm break-words whitespace-normal leading-tight">
                                    ${song.song}${labels}
                                </div>
                            </div>
                            <div class="col-span-4 md:col-span-4 min-w-0 flex flex-col justify-center pr-8">
                                <div class="text-[10px] md:text-xs text-gray-600 flex items-center gap-1 flex-wrap">
                                    <i data-lucide="mic" class="w-3 h-3 text-gray-400 flex-shrink-0"></i>
                                    <span class="break-words whitespace-normal leading-tight">${song.singer || '-'}</span>
                                </div>
                                <div class="text-[10px] text-gray-400 mt-0.5 break-words whitespace-normal leading-tight">
                                    ${song.artist || ''} ${song.work ? '/ ' + song.work : ''}
                                </div>
                            </div>
                            
                            <!-- Actions Column -->
                            <div class="col-span-3 md:col-span-2 flex justify-end items-center gap-1 md:gap-2">
                                <a href="${searchUrl}" target="_self" rel="noopener noreferrer" 
                                   class="p-1.5 md:p-2 bg-green-50 text-green-600 hover:bg-green-100 rounded-lg transition-colors border border-green-200 shadow-sm flex-shrink-0" title="検索">
                                    <i data-lucide="search" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
                                </a>

                                <div class="flex items-center gap-0.5 md:gap-1 opacity-100 transition-opacity">
                                    <button onclick="app.editSong(${song.id})" class="p-1.5 md:p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="編集">
                                        <i data-lucide="edit-3" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
                                    </button>
                                    <div class="flex flex-col gap-0.5">
                                        <button onclick="app.moveSong(${song.id}, 'up')" class="p-0.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">
                                            <i data-lucide="arrow-up" class="w-3 h-3"></i>
                                        </button>
                                        <button onclick="app.moveSong(${song.id}, 'down')" class="p-0.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded">
                                            <i data-lucide="arrow-down" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                    <button onclick="app.deleteSong(${song.id})" class="p-1.5 md:p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5 md:w-4 md:h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }

                if (totalPages > 1) {
                    els.pagination.innerHTML = `
                        <button onclick="app.setPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled class="opacity-30"' : 'class="hover:text-blue-600"'}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        <span class="font-mono text-gray-500">Page ${currentPage} / ${totalPages}</span>
                        <button onclick="app.setPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled class="opacity-30"' : 'class="hover:text-blue-600"'}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    `;
                    els.pagination.classList.remove('hidden');
                } else {
                    els.pagination.classList.add('hidden');
                }

                lucide.createIcons();
            }

            // --- Actions ---

            function setActiveTab(tab) {
                activeTab = tab;
                currentPage = 1; 
                render();
            }

            // Updated Search Logic
            function triggerSearch() {
                const query = els.searchInput.value;
                setSearchQuery(query);
            }

            function setSearchQuery(query) {
                searchQuery = query;
                currentPage = 1;
                render();
            }

            function setPage(page) {
                currentPage = page;
                render();
            }

            // --- Room Setting Actions ---

            function openRoomModal() {
                let html = '';
                for (const [port, name] of Object.entries(ROOMS)) {
                    const isSelected = parseInt(port) === targetPort;
                    const bgClass = isSelected ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200';
                    html += `
                        <button onclick="app.selectPort(${port})" class="px-3 py-2 rounded-lg text-xs font-bold transition-all ${bgClass}">
                            ${name} <span class="opacity-70 text-[10px] block font-normal">${port}</span>
                        </button>
                    `;
                }
                els.roomButtonsContainer.innerHTML = html;
                els.roomInputPort.value = targetPort;
                els.modals.room.classList.remove('hidden');
            }

            function closeRoomModal() {
                els.modals.room.classList.add('hidden');
            }

            function selectPort(port) {
                targetPort = parseInt(port);
                localStorage.setItem('targetPort', targetPort);
                closeRoomModal();
                render();
            }

            function setCustomPort() {
                const port = parseInt(els.roomInputPort.value);
                if (port && port > 0) {
                    selectPort(port);
                } else {
                    showDialog('有効なポート番号を入力してください', 'alert');
                }
            }

            // --- Song Edit Actions ---

            function saveSong() { 
                const singer = els.inputs.singer.value.trim();
                const songName = els.inputs.song.value.trim();
                const isPartDivision = els.inputs.partDivision.checked;
                const isPracticing = els.inputs.practicing.checked;
                const isReviewNeeded = els.inputs.reviewNeeded.checked;

                if (!songName) {
                    showDialog('曲名は必須です', 'alert');
                    return;
                }

                const songData = {
                    singer: singer,
                    work: els.inputs.work.value.trim(),
                    artist: els.inputs.artist.value.trim(),
                    song: songName,
                    isPartDivision: isPartDivision,
                    isPracticing: isPracticing,
                    isReviewNeeded: isReviewNeeded
                };

                if (editingId) {
                    const index = songs.findIndex(s => s.id === editingId);
                    if (index !== -1) {
                        songs[index] = { ...songs[index], ...songData };
                        showDialog('曲情報を更新しました。', 'alert');
                    }
                } else {
                    songs.push({
                        id: Date.now() + Math.random(),
                        ...songData
                    });
                }
                
                if (singer) activeTab = singer;
                resetForm();
                render();
            }

            function editSong(id) {
                const song = songs.find(s => s.id === id);
                if (!song) return;

                els.inputs.singer.value = song.singer || '';
                els.inputs.work.value = song.work || '';
                els.inputs.artist.value = song.artist || '';
                els.inputs.song.value = song.song || '';
                els.inputs.partDivision.checked = song.isPartDivision || false;
                els.inputs.practicing.checked = song.isPracticing || false;
                els.inputs.reviewNeeded.checked = song.isReviewNeeded || false;

                editingId = id;
                
                els.form.titleText.innerText = "登録情報を編集";
                els.form.icon.setAttribute('data-lucide', 'edit-3');
                els.form.submitBtn.innerText = "更新する";
                els.form.submitBtn.className = "w-full py-2.5 mt-2 bg-green-600 hover:bg-green-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]";
                els.form.cancelBtn.classList.remove('hidden');
                
                els.form.container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                lucide.createIcons();
                render(); 
            }

            function cancelEdit() {
                resetForm();
                render();
            }

            function resetForm() {
                els.inputs.song.value = '';
                els.inputs.work.value = '';
                els.inputs.artist.value = '';
                els.inputs.partDivision.checked = false;
                els.inputs.practicing.checked = false;
                els.inputs.reviewNeeded.checked = false;
                editingId = null;
                
                els.form.titleText.innerText = "新規登録";
                els.form.icon.setAttribute('data-lucide', 'plus');
                els.form.submitBtn.innerText = "リストに追加";
                els.form.submitBtn.className = "w-full py-2.5 mt-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold rounded-lg shadow-md hover:shadow-lg transition-all active:scale-[0.98]";
                els.form.cancelBtn.classList.add('hidden');
                lucide.createIcons();
            }

            function addSong() { saveSong(); }

            function deleteSong(id) {
                showDialog('本当に削除しますか？', 'confirm', () => {
                    songs = songs.filter(s => s.id !== id);
                    if (!deletedIds.includes(id)) {
                        deletedIds.push(id);
                        localStorage.setItem('deletedIds', JSON.stringify(deletedIds));
                    }
                    if (editingId === id) cancelEdit();
                    render();
                });
            }

            // Updated Move Logic for Reverse Display
            // "Up" in UI (visual up) = Newer = Index+1 in underlying 'songs' array
            // "Down" in UI (visual down) = Older = Index-1 in underlying 'songs' array
            // Note: Filtered list is also bottom-up (Old->New). 
            function moveSong(id, direction) {
                const globalIndex = songs.findIndex(s => s.id === id);
                if (globalIndex === -1) return;

                // Create a filtered list to find the adjacent item in the *filtered* view
                let currentList = songs;
                if (activeTab !== 'ALL') currentList = currentList.filter(s => s.singer === activeTab);
                if (searchQuery) {
                     const queries = searchQuery.toLowerCase().replace(/　/g, ' ').split(' ').filter(q => q);
                     currentList = currentList.filter(s => {
                        const targetText = `${s.song} ${s.work} ${s.artist}`.toLowerCase();
                        return queries.every(q => targetText.includes(q));
                    });
                }

                // Find index in the filtered list (Old -> New)
                const visualIndex = currentList.findIndex(s => s.id === id);
                if (visualIndex === -1) return;

                let targetVisualIndex = -1;
                // UI "Up" means visually higher (newer). In Old->New list, this is index + 1.
                if (direction === 'up' && visualIndex < currentList.length - 1) {
                    targetVisualIndex = visualIndex + 1;
                }
                // UI "Down" means visually lower (older). In Old->New list, this is index - 1.
                if (direction === 'down' && visualIndex > 0) {
                    targetVisualIndex = visualIndex - 1;
                }

                if (targetVisualIndex !== -1) {
                    const swapSong = currentList[targetVisualIndex];
                    // Find swap song in global list
                    const swapGlobalIndex = songs.findIndex(s => s.id === swapSong.id);
                    
                    // Swap
                    [songs[globalIndex], songs[swapGlobalIndex]] = [songs[swapGlobalIndex], songs[globalIndex]];
                    render();
                }
            }

            // --- Migration Feature (File Import) ---
            
            function importFile(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                            showDialog(`ファイルから ${importedData.length} 件のデータを読み込みました。\n反映するには「同期して保存」を押してください。`, 'alert');
                            songs = importedData;
                            render();
                        } else {
                            showDialog('データの形式が正しくありません。', 'alert');
                        }
                    } catch (error) {
                        showDialog('ファイルの読み込みに失敗しました。', 'alert');
                    }
                };
                reader.readAsText(file);
                input.value = '';
            }

            // --- GAS Communication ---

            async function saveToGAS() {
                if (!GAS_API_URL) {
                    showDialog('GASのURLが設定されていません。', 'alert');
                    return;
                }

                updateStatus('サーバーと同期中...', true);

                try {
                    // 1. Get Latest from Server with cache busting
                    let serverSongs = [];
                    try {
                        const res = await fetch(GAS_API_URL + '?t=' + new Date().getTime());
                        const text = await res.text();
                        try {
                            const data = JSON.parse(text);
                            if (Array.isArray(data)) {
                                serverSongs = data;
                            }
                        } catch(e) { console.log('JSON Parse error', e); }
                    } catch(e) { console.log('Fetch error', e); }

                    // 2. Merge Logic
                    const localIds = new Set(songs.map(s => s.id));
                    const newServerSongs = serverSongs.filter(s => 
                        !localIds.has(s.id) && !deletedIds.includes(s.id)
                    );
                    const mergedSongs = [...songs, ...newServerSongs];
                    songs = mergedSongs;
                    render(); 

                    // 3. Post to GAS (Overwrite A1)
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(mergedSongs),
                        headers: { "Content-Type": "text/plain;charset=utf-8" }
                    });

                    // Success
                    deletedIds = [];
                    localStorage.setItem('deletedIds', JSON.stringify(deletedIds));

                    updateStatus('同期・保存完了！');
                    setTimeout(() => updateStatus(``), 3000);

                } catch (error) {
                    showDialog(`保存エラー: ${error.message}\nGASのデプロイ設定を確認してください。`, 'alert');
                    updateStatus('保存失敗');
                }
            }

            async function loadFromGAS(silent = false) {
                if (!GAS_API_URL) {
                    if(!silent) showDialog('GASのURLが設定されていません。', 'alert');
                    return;
                }

                const runLoad = async () => {
                    updateStatus('読み込み中...', true);
                    try {
                        const res = await fetch(GAS_API_URL + '?t=' + new Date().getTime());
                        const text = await res.text();
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch(e) {
                            console.error("Parse Error:", text);
                            throw new Error("サーバーからの応答が不正です。\n(HTMLが返されました。GASのアクセス権限を確認してください)");
                        }

                        if (Array.isArray(data)) {
                            songs = data;
                            activeTab = 'ALL';
                            currentPage = 1;
                            deletedIds = [];
                            localStorage.setItem('deletedIds', JSON.stringify(deletedIds));
                            render();
                            updateStatus('読み込み完了');
                            setTimeout(() => updateStatus(``), 3000);
                        } else {
                            throw new Error('データ形式が不正です');
                        }
                    } catch (error) {
                        if(!silent) showDialog(`【通信エラー】\n${error.message}\n\n考えられる原因:\n1. GASのデプロイが「新バージョン」で更新されていない\n2. アクセス権限が「全員」になっていない\n3. URLが間違っている`, 'alert');
                        updateStatus('エラー');
                    }
                };

                if (silent) {
                    await runLoad();
                } else {
                    showDialog('サーバーからデータを読み込みますか？\nローカルの変更は上書きされます。', 'confirm', runLoad);
                }
            }

            // --- UI Helper Functions ---

            function updateStatus(msg, animate = false) {
                els.status.innerText = msg;
                if (animate) {
                    els.status.classList.add('animate-pulse');
                } else {
                    els.status.classList.remove('animate-pulse');
                }
                if (els.refreshIcon) els.refreshIcon.classList.remove('animate-spin-slow');
            }

            function showDialog(message, type = 'alert', onConfirm = null) {
                const d = els.modals.dialog;
                document.getElementById('dialog-message').innerText = message;
                const actions = document.getElementById('dialog-actions');
                actions.innerHTML = '';
                const close = () => d.classList.add('hidden');
                
                if (type === 'confirm') {
                    actions.innerHTML = `
                        <button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="px-4 py-2 bg-gray-200 rounded-lg text-sm font-bold">キャンセル</button>
                        <button id="confirm-ok-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">OK</button>
                    `;
                    document.getElementById('confirm-ok-btn').onclick = () => { close(); if(onConfirm) onConfirm(); };
                } else {
                    actions.innerHTML = `<button onclick="document.getElementById('custom-dialog').classList.add('hidden')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold w-full">OK</button>`;
                }
                d.classList.remove('hidden');
            }

            // Init Logic for Auto-load
            const currentDataStr = JSON.stringify(songs);
            const initialDataStr = JSON.stringify(initialData);
            
            if (GAS_API_URL) {
                if (!localStorage.getItem('myMusicList') || currentDataStr === initialDataStr) {
                    loadFromGAS(true);
                }
            }
            
            render();

            return {
                addSong, deleteSong, moveSong, setActiveTab, setPage,
                saveToGAS, loadFromGAS, importFile, triggerSearch, setSearchQuery,
                openRoomModal, closeRoomModal, selectPort, setCustomPort, saveSong, editSong, cancelEdit
            };
        })();
    </script>
</body>
</html>
